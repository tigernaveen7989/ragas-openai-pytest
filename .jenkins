pipeline {
    agent any

    environment {
        ALLURE_RESULTS = 'testreports/allure-results'
        ALLURE_REPORT  = 'allure-report'
        VENV_PATH      = 'C:\\Jenkins\\PythonEnvs\\ragas-env'  // Persistent venv outside workspace
    }

    stages {

        stage('Clone Repo') {
            steps {
                echo "Cloning GitHub repository (master branch)..."
                git branch: 'master', url: 'https://github.com/tigernaveen7989/ragas-openai-pytest.git'
            }
        }

        stage('Setup Python Environment') {
            steps {
                echo "Setting up Python virtual environment..."
                script {
                    catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
                        bat """
                            if not exist "${VENV_PATH}" (
                                echo Creating new virtual environment...
                                python -m venv "${VENV_PATH}"
                                call "${VENV_PATH}\\Scripts\\activate"
                                pip install --upgrade pip
                                pip install -r requirements.txt
                            ) else (
                                echo Reusing existing virtual environment...
                                call "${VENV_PATH}\\Scripts\\activate"
                                pip install --upgrade pip
                                pip install --upgrade -r requirements.txt
                            )
                        """
                    }
                }
            }
        }

        stage('Run Pytest') {
            steps {
                echo "Running specific Pytest test..."
                script {
                    catchError(buildResult: 'UNSTABLE', stageResult: 'UNSTABLE') {
                        bat """
                            call "${VENV_PATH}\\Scripts\\activate"
                            pytest tests/test_rest_assured.py::TestRestAssured::test_aspect_critic --alluredir=${ALLURE_RESULTS} --continue-on-collection-errors
                        """
                    }
                }
            }
        }

        stage('Allure Report Generation') {
            steps {
                echo "Generating Allure HTML report..."
                script {
                    catchError(buildResult: 'UNSTABLE', stageResult: 'SUCCESS') {
                        bat """
                            allure generate ${ALLURE_RESULTS} -o ${ALLURE_REPORT} --clean
                        """
                    }
                }
            }
        }

        stage('Publish Allure Report') {
            steps {
                script {
                    catchError(buildResult: 'UNSTABLE', stageResult: 'SUCCESS') {
                        allure([
                            includeProperties: false,
                            jdk: '',
                            properties: [],
                            reportBuildPolicy: 'ALWAYS',
                            results: [[path: "${ALLURE_RESULTS}"]]
                        ])
                    }
                }
            }
        }
    }

    post {
        always {
            echo "Pipeline finished. Workspace not cleaned to preserve venv."
        }
        success {
            echo "Pipeline executed successfully!"
        }
        failure {
            echo "Pipeline failed. Check logs for details."
        }
    }
}
